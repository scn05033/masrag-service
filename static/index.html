<!doctype html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>감성 음악 가사 생성 (MAS-RAG)</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace }
    .result { white-space: pre-wrap; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px }
    .spinner { width:16px; height:16px; border:2px solid #e5e7eb; border-top-color:#111; border-radius:50%; animation:spin .8s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }
  </style>
</head>
<body>
  <main class="container">
    <h2>이미지 → 분석 → (MAS)RAG 가사 생성</h2>

    <form id="form" onsubmit="return false;">
      <input id="file" type="file" accept="image/*" required />
      <label><input id="use_mas" type="checkbox" checked> MAS 사용</label>
      <label>라운드 <input id="rounds" type="number" min="1" max="2" value="1"></label>
      <label>Top K <input id="topk" type="number" min="1" max="5" value="3"></label>
      <button id="runBtn" type="button">가사 생성</button>
    </form>

    <h4>이미지 분석 결과</h4>
    <pre id="analysis" class="result mono">아직 없음</pre>

    <h4>작업/사고 과정(trace)</h4>
    <pre id="trace" class="result mono">아직 없음</pre>

    <h4>가사</h4>
    <textarea id="lyrics" class="mono" rows="12" readonly style="width:100%"></textarea>

    <h4>오디오</h4>
    <div id="audioArea" class="result">아직 없음</div>
  </main>

  <script>
    const API = "http://127.0.0.1:8000";
    const $  = (id) => document.getElementById(id);
    const btn = $("runBtn");

    function setLoading(v){
      btn.disabled = v;
      btn.innerHTML = v ? `<span class="spinner"></span> 생성 중...` : "가사 생성";
    }
    function renderTrace(trace) {
    if (!trace) return "(trace 없음)";

    const lines = [];
    // 1) 플랜
    if (trace.plan) {
      const chk = Array.isArray(trace.plan.checklist) ? trace.plan.checklist.join(", ") : "";
      lines.push("▶ Planner:");
      lines.push("  - 구조 : " + (trace.plan.structure || []).join(", "));
      if (chk) lines.push("  - 체크 : " + chk);
      lines.push("");
    }

    // 2) RAG 컨텍스트
    if (Array.isArray(trace.contexts)) {
      lines.push(`▶ RAG가 가져온 문맥: ${trace.contexts.length}개`);
      trace.contexts.slice(0, 3).forEach((c, i) => {
        lines.push(`  [${i+1}] ${c.slice(0, 80)}...`);
      });
      lines.push("");
    }

    // 3) 라운드
    if (Array.isArray(trace.rounds)) {
  lines.push(`▶ MAS 라운드: ${trace.rounds.length}회`);
  trace.rounds.forEach((r, idx) => {
    lines.push(`  - Round ${idx+1}`);

    if (r.emotion_review) {
      lines.push("    감정: " + r.emotion_review.replace(/\s+/g, " ").slice(0, 160));
    }
    if (r.situation_review) {
      lines.push("    장면: " + r.situation_review.replace(/\s+/g, " ").slice(0, 160));
    }

    const beforeLines = (r.draft_before || "").split("\n");
    const afterLines  = (r.draft_after  || "").split("\n");

    lines.push("    수정 결과:");
    const maxLen = Math.max(beforeLines.length, afterLines.length);

    for (let i = 0; i < maxLen; i++) {
      const b = beforeLines[i] || "";
      const a = afterLines[i] || "";
      if (b === a) {
        // 안 바뀐 줄
        lines.push("      " + a);
      } else {
        // 바뀐 줄만 강조
        lines.push("      👉 " + a + "   (was: " + b + ")");
      }
    }

    lines.push("");
  });
}

    // 4) 최종
    if (trace.final) {
      const firstLine = trace.final.split("\n")[0];
      lines.push("▶ 최종 첫 줄:");
      lines.push("  " + firstLine);
    }

    return lines.join("\n");
  }

    async function pollAudio(taskId, ms=4000, maxTry=45){
      for(let i=0; i<maxTry; i++){
        const r = await fetch(`${API}/audio-status?task_id=${encodeURIComponent(taskId)}`);
        const d = await r.json();
        if(d.status === "done" && d.songs?.length){
          const s = d.songs.find(x => x.audio_url) || d.songs[0];
          if(s?.audio_url){
            $("audioArea").innerHTML =
              `<audio controls src="${s.audio_url}" style="width:100%"></audio><div>${s.title||""}</div>`;
            return;
          }
        } else if (d.status === "error") {
          $("audioArea").textContent = "생성 실패: " + (d.error || "알 수 없음");
          return;
        }
        await new Promise(res => setTimeout(res, ms));
      }
      $("audioArea").textContent = "대기 시간 초과";
    }

    btn.onclick = async () => {
      const f = $("file").files[0];
      if (!f) {
        alert("이미지를 선택하세요.");
        return;
      }
      setLoading(true);
      $("trace").textContent = "작업 중...";
      $("audioArea").textContent = "대기 중...";

      try {
        const fd = new FormData();
        fd.append("file", f);
        fd.append("use_mas", $("use_mas").checked ? "true" : "false");
        fd.append("rounds", String(Number($("rounds").value || 1)));
        fd.append("top_k", String(Number($("topk").value || 3)));
        fd.append("debug", "true");   // 👈 백엔드가 trace도 주도록

        const res = await fetch(`${API}/create-song`, { method: "POST", body: fd });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`create-song 실패 (HTTP ${res.status})\n${txt}`);
        }
        const data = await res.json();

        // 1) 분석 결과
        $("analysis").textContent = JSON.stringify(data.analysis, null, 2);

        // 2) 가사
        $("lyrics").value = data.lyrics || "(결과 없음)";

        // 3) trace (백엔드가 넘겨준 경우에만)
        //    data.trace가 없으면 "trace 없음"으로
       if (data.trace) {
  $("trace").textContent = renderTrace(data.trace);
} else {
  $("trace").textContent = "(trace 없음)";
}


        // 4) 오디오
        if (data.task_id) {
          await pollAudio(data.task_id);
        } else {
          $("audioArea").textContent = "음악 생성 안 함 (task_id 없음)";
        }

      } catch (e) {
        alert(e.message || e);
        console.error(e);
        $("trace").textContent = "에러: " + (e.message || e);
      } finally {
        setLoading(false);
      }
    };
  </script>
</body>
</html>
