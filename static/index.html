<!doctype html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>ê°ì„± ìŒì•… ê°€ì‚¬ ìƒì„± (MAS-RAG)</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace }
    .result { white-space: pre-wrap; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px }
    .spinner { width:16px; height:16px; border:2px solid #e5e7eb; border-top-color:#111; border-radius:50%; animation:spin .8s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }
  </style>
</head>
<body>
  <main class="container">
    <h2>ì´ë¯¸ì§€ â†’ ë¶„ì„ â†’ (MAS)RAG ê°€ì‚¬ ìƒì„±</h2>

    <form id="form" onsubmit="return false;">
      <input id="file" type="file" accept="image/*" required />
      <label><input id="use_mas" type="checkbox" checked> MAS ì‚¬ìš©</label>
      <label>ë¼ìš´ë“œ <input id="rounds" type="number" min="1" max="2" value="1"></label>
      <label>Top K <input id="topk" type="number" min="1" max="5" value="3"></label>
      <button id="runBtn" type="button">ê°€ì‚¬ ìƒì„±</button>
    </form>

    <h4>ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼</h4>
    <pre id="analysis" class="result mono">ì•„ì§ ì—†ìŒ</pre>

    <h4>ì‘ì—…/ì‚¬ê³  ê³¼ì •(trace)</h4>
    <pre id="trace" class="result mono">ì•„ì§ ì—†ìŒ</pre>

    <h4>ê°€ì‚¬</h4>
    <textarea id="lyrics" class="mono" rows="12" readonly style="width:100%"></textarea>

    <h4>ì˜¤ë””ì˜¤</h4>
    <div id="audioArea" class="result">ì•„ì§ ì—†ìŒ</div>
  </main>

  <script>
    const API = "http://127.0.0.1:8000";
    const $  = (id) => document.getElementById(id);
    const btn = $("runBtn");

    function setLoading(v){
      btn.disabled = v;
      btn.innerHTML = v ? `<span class="spinner"></span> ìƒì„± ì¤‘...` : "ê°€ì‚¬ ìƒì„±";
    }
    function renderTrace(trace) {
    if (!trace) return "(trace ì—†ìŒ)";

    const lines = [];
    // 1) í”Œëœ
    if (trace.plan) {
      const chk = Array.isArray(trace.plan.checklist) ? trace.plan.checklist.join(", ") : "";
      lines.push("â–¶ Planner:");
      lines.push("  - êµ¬ì¡° : " + (trace.plan.structure || []).join(", "));
      if (chk) lines.push("  - ì²´í¬ : " + chk);
      lines.push("");
    }

    // 2) RAG ì»¨í…ìŠ¤íŠ¸
    if (Array.isArray(trace.contexts)) {
      lines.push(`â–¶ RAGê°€ ê°€ì ¸ì˜¨ ë¬¸ë§¥: ${trace.contexts.length}ê°œ`);
      trace.contexts.slice(0, 3).forEach((c, i) => {
        lines.push(`  [${i+1}] ${c.slice(0, 80)}...`);
      });
      lines.push("");
    }

    // 3) ë¼ìš´ë“œ
    if (Array.isArray(trace.rounds)) {
  lines.push(`â–¶ MAS ë¼ìš´ë“œ: ${trace.rounds.length}íšŒ`);
  trace.rounds.forEach((r, idx) => {
    lines.push(`  - Round ${idx+1}`);

    if (r.emotion_review) {
      lines.push("    ê°ì •: " + r.emotion_review.replace(/\s+/g, " ").slice(0, 160));
    }
    if (r.situation_review) {
      lines.push("    ì¥ë©´: " + r.situation_review.replace(/\s+/g, " ").slice(0, 160));
    }

    const beforeLines = (r.draft_before || "").split("\n");
    const afterLines  = (r.draft_after  || "").split("\n");

    lines.push("    ìˆ˜ì • ê²°ê³¼:");
    const maxLen = Math.max(beforeLines.length, afterLines.length);

    for (let i = 0; i < maxLen; i++) {
      const b = beforeLines[i] || "";
      const a = afterLines[i] || "";
      if (b === a) {
        // ì•ˆ ë°”ë€ ì¤„
        lines.push("      " + a);
      } else {
        // ë°”ë€ ì¤„ë§Œ ê°•ì¡°
        lines.push("      ğŸ‘‰ " + a + "   (was: " + b + ")");
      }
    }

    lines.push("");
  });
}

    // 4) ìµœì¢…
    if (trace.final) {
      const firstLine = trace.final.split("\n")[0];
      lines.push("â–¶ ìµœì¢… ì²« ì¤„:");
      lines.push("  " + firstLine);
    }

    return lines.join("\n");
  }

    async function pollAudio(taskId, ms=4000, maxTry=45){
      for(let i=0; i<maxTry; i++){
        const r = await fetch(`${API}/audio-status?task_id=${encodeURIComponent(taskId)}`);
        const d = await r.json();
        if(d.status === "done" && d.songs?.length){
          const s = d.songs.find(x => x.audio_url) || d.songs[0];
          if(s?.audio_url){
            $("audioArea").innerHTML =
              `<audio controls src="${s.audio_url}" style="width:100%"></audio><div>${s.title||""}</div>`;
            return;
          }
        } else if (d.status === "error") {
          $("audioArea").textContent = "ìƒì„± ì‹¤íŒ¨: " + (d.error || "ì•Œ ìˆ˜ ì—†ìŒ");
          return;
        }
        await new Promise(res => setTimeout(res, ms));
      }
      $("audioArea").textContent = "ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼";
    }

    btn.onclick = async () => {
      const f = $("file").files[0];
      if (!f) {
        alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      setLoading(true);
      $("trace").textContent = "ì‘ì—… ì¤‘...";
      $("audioArea").textContent = "ëŒ€ê¸° ì¤‘...";

      try {
        const fd = new FormData();
        fd.append("file", f);
        fd.append("use_mas", $("use_mas").checked ? "true" : "false");
        fd.append("rounds", String(Number($("rounds").value || 1)));
        fd.append("top_k", String(Number($("topk").value || 3)));
        fd.append("debug", "true");   // ğŸ‘ˆ ë°±ì—”ë“œê°€ traceë„ ì£¼ë„ë¡

        const res = await fetch(`${API}/create-song`, { method: "POST", body: fd });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`create-song ì‹¤íŒ¨ (HTTP ${res.status})\n${txt}`);
        }
        const data = await res.json();

        // 1) ë¶„ì„ ê²°ê³¼
        $("analysis").textContent = JSON.stringify(data.analysis, null, 2);

        // 2) ê°€ì‚¬
        $("lyrics").value = data.lyrics || "(ê²°ê³¼ ì—†ìŒ)";

        // 3) trace (ë°±ì—”ë“œê°€ ë„˜ê²¨ì¤€ ê²½ìš°ì—ë§Œ)
        //    data.traceê°€ ì—†ìœ¼ë©´ "trace ì—†ìŒ"ìœ¼ë¡œ
       if (data.trace) {
  $("trace").textContent = renderTrace(data.trace);
} else {
  $("trace").textContent = "(trace ì—†ìŒ)";
}


        // 4) ì˜¤ë””ì˜¤
        if (data.task_id) {
          await pollAudio(data.task_id);
        } else {
          $("audioArea").textContent = "ìŒì•… ìƒì„± ì•ˆ í•¨ (task_id ì—†ìŒ)";
        }

      } catch (e) {
        alert(e.message || e);
        console.error(e);
        $("trace").textContent = "ì—ëŸ¬: " + (e.message || e);
      } finally {
        setLoading(false);
      }
    };
  </script>
</body>
</html>
